# Telegram Wiki Bot

An AI-assisted Telegram bot that monitors configured channels or groups, groups informational updates, and turns them into publishable posts for Notion and GitHub Pages. The project is written in TypeScript and runs on Node.js.

## Features

- Monitor Telegram channels/groups and collect new messages automatically.
- AI-powered message analysis using Google Gemini to detect informational content and generate summaries.
- Optional image captioning via Gemini Vision.
- Automatic publishing to Notion databases and GitHub repositories (for static sites such as GitHub Pages).
- Manual review flow with pending posts, inline review controls, and basic editing from Telegram.
- Health-check endpoint for production deployments.

## Prerequisites

- Node.js 18 or later
- PostgreSQL database (connection string provided via `DATABASE_URL`)
- API credentials:
  - Telegram Bot Token
  - Google Generative AI API Key
  - Optional: Notion API Key & Database ID, GitHub Personal Access Token

## Getting Started

1. **Install dependencies**
   ```bash
   npm install
   ```

2. **Configure environment**
   - Copy `.env.example` to `.env` and fill in the required values.
   - The bot requires at least `TELEGRAM_BOT_TOKEN`, `OWNER_USER_ID`, `GOOGLE_AI_API_KEY`, and `DATABASE_URL` to start.

3. **Build the project**
   ```bash
   npm run build
   ```

4. **Run the bot**
   ```bash
   npm start
   ```

   During development you can also run:
   ```bash
   npm run dev
   ```

## Development Scripts

- `npm run lint` ‚Äì Lint the TypeScript source using ESLint.
- `npm run build` ‚Äì Compile TypeScript to JavaScript in the `dist/` directory.
- `npm test` ‚Äì Run linting followed by the TypeScript build.

## Telegram Commands & Menu

Once you authorize yourself with the bot, you can control it entirely from Telegram:

| Command / Menu | Description |
| -------------- | ----------- |
| `/menu` or reply button | Reopen the main keyboard with quick actions. |
| `/status` or `üìä Status` | Show monitored sources, pending messages, and publishing stats. |
| `/settings` or `‚öôÔ∏è Settings` | Toggle auto-publish, adjust message grouping, and set Notion/GitHub targets. |
| `/subscribe` or `‚ûï Subscribe` | Get instructions for adding new channels or groups. |
| `/sources` or `üìã List Sources` | List every monitored source with its identifier for quick management. |
| `/pending` or `üìù Pending Posts` | Review, publish, reject, or edit drafts generated by the bot. |
| `/users` or `üë• Manage Users` | View all users and learn how to authorize or revoke access. |
| `/unsubscribe <id>` | Stop monitoring a source by its numeric id from `/sources`. |
| `/help` | Display the full welcome message and quick command list. |

## Project Structure

```
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # Main bot implementation
‚îú‚îÄ‚îÄ dist/                 # Compiled JavaScript (after build)
‚îú‚îÄ‚îÄ .env.example          # Environment variable template
‚îú‚îÄ‚îÄ eslint.config.mjs     # ESLint configuration
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îî‚îÄ‚îÄ README.md
```

## Database Schema

The bot manages users, settings, monitored sources, pending messages, and generated blog posts inside PostgreSQL. Tables are created automatically at startup if they do not already exist.

## Deploying to Fly.io

The repository ships with a production-ready `Dockerfile` and `fly.toml` so you can deploy directly to [Fly.io](https://fly.io/) using their free tier.

1. **Install the Fly CLI**
   ```bash
   curl -L https://fly.io/install.sh | sh
   # or visit https://fly.io/docs/hands-on/install-flyctl
   ```

2. **Log in and create the app**
   ```bash
   fly auth login
   fly apps create telegram-wiki-bot
   ```

3. **Provision PostgreSQL (optional but recommended)**
   ```bash
   fly postgres create --name telegram-wiki-bot-db
   fly postgres attach --postgres-app telegram-wiki-bot-db telegram-wiki-bot
   ```
   Record the generated `DATABASE_URL` secret printed by Fly.

4. **Configure secrets**
   ```bash
   fly secrets set \
     TELEGRAM_BOT_TOKEN="your_bot_token" \
     OWNER_USER_ID="123456789" \
     GOOGLE_AI_API_KEY="your_gemini_key" \
     DATABASE_URL="postgres://..." \
     NOTION_API_KEY="optional_notion_key" \
     GITHUB_TOKEN="optional_github_token"
   ```

5. **Deploy the bot**
   ```bash
   fly deploy
   ```

6. **Verify health**
   ```bash
   fly open /health
   fly logs
   ```

The Fly runtime will automatically expose the `/health` endpoint (listening on port `8080`) so you can plug it into external monitors. If you need to rotate credentials later, update them with `fly secrets set` and redeploy.

## Deployment Notes

- The `/health` endpoint exposes a JSON status payload useful for uptime checks.
- When deploying to services such as Fly.io or Render, ensure your Telegram webhook/long polling configuration and outbound network access for Notion, GitHub, and Google APIs.

## License

This project is released under the [MIT License](LICENSE).
